--BEGIN TRAN 
ALTER PROC USP_POP_004_RESULT_NEW_DR_SAVE
(
--DECLARE
     @DIV_CD        NVARCHAR(10) = '01' 
    ,@PLANT_CD      NVARCHAR(10) = '1130' 
    ,@ORDER_NO      NVARCHAR(50) = 'PD250929011' 
    ,@REVISION      INT = 2
    ,@WC_CD         NVARCHAR(20) = '13GA' 
    ,@LINE_CD       NVARCHAR(20) = '13G01A' 
    ,@PROC_CD       NVARCHAR(20) = 'RK'
    ,@EQP_CD        NVARCHAR(50) = 'LFG01A-01A-RK-0701'
    ,@SDATE         NVARCHAR(10) = '2025-12-08'
    ,@DR_DT         NVARCHAR(1)  = '4'
    ,@USER_ID       NVARCHAR(15) = 'admin' 
    ,@MSG_CD        NVARCHAR(4)   OUTPUT 
    ,@MSG_DETAIL    NVARCHAR(MAX) OUTPUT   
--)
)
AS
BEGIN TRY 

    DECLARE @PROC_NO      NVARCHAR(50) 
        ,@ORDER_TYPE   NVARCHAR(10) 
        ,@ORDER_FORM   NVARCHAR(10) 
        ,@ROUT_NO      NVARCHAR(50) 
        ,@ROUT_VER     INT 
        ,@RESULT_SEQ   INT 
        ,@ITEM_CD      NVARCHAR(50) 
        ,@LOT_NO       NVARCHAR(50) 
        ,@RK_DATE      DATETIME 
        ,@DAY_FLG      NVARCHAR(1) 

    DECLARE @STR_DATE NVARCHAR(8) = CONVERT(NVARCHAR(8), CAST(@SDATE AS DATETIME), 112)           
    -- 기준정보 가지고 오기
    

    SELECT @PROC_NO = A.PROC_NO, @ORDER_TYPE = A.ORDER_TYPE, @ORDER_FORM = A.ORDER_FORM, @ROUT_NO = A.ROUT_NO, @ROUT_VER = A.ROUT_VER 
    , @ITEM_CD = A.ITEM_CD 
        FROM PD_ORDER A WITH (NOLOCK) 
    WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
    
    SET @RESULT_SEQ = ISNULL((
        SELECT MAX(A.RESULT_SEQ) FROM PD_RESULT A
        WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
        AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
        AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'Y'),0) + 1

    IF @PROC_CD IN ('RK','RH')
    BEGIN 
        SET @RK_DATE = CAST(@SDATE + ' ' + (SELECT SUB_NM FROM BA_SUB_CD  WHERE SUB_CD = @DR_DT  AND MAIN_CD = 'POP12') AS DATETIME)

    END 
    ELSE 
    BEGIN 
        SET @RK_DATE = CONVERT(NVARCHAR(20),GETDATE(), 120)
    END 

    SET @DAY_FLG = dbo.UFNSR_GET_DAYNIGHT(CAST(@RK_DATE AS DATETIME),'D')

    EXEC USP_CM_AUTO_NUMBERING 'PR', @STR_DATE, @USER_ID, @LOT_NO OUT                 

    INSERT INTO PD_RESULT
    (
    DIV_CD, PLANT_CD, PROC_NO, ORDER_NO, REVISION,
    ORDER_TYPE, ORDER_FORM, ROUT_NO, ROUT_VER, WC_CD,
    LINE_CD, PROC_CD, S_CHK, RESULT_SEQ, ITEM_CD,
    LOT_NO, LOT_SEQ, RESULT_QTY, GOOD_QTY, GROUP_LOT,
    GROUP_YN, RK_DATE, SDATE, EDATE, SIL_DT,
    DAY_FLG, J_CHK, J_SEQ, J_VAL, EQP_CD,
    INSERT_ID, INSERT_DT, UPDATE_ID, UPDATE_DT, ZMESIFNO, REMARK

    )

    SELECT
    @DIV_CD, @PLANT_CD, @PROC_NO, @ORDER_NO, @REVISION,
    @ORDER_TYPE, @ORDER_FORM, @ROUT_NO, @ROUT_VER, @WC_CD,
    @LINE_CD, @PROC_CD, 'Y', @RESULT_SEQ, @ITEM_CD,
    @LOT_NO, 0, 0, 0, @LOT_NO,
    'N', @SDATE, @RK_DATE, @RK_DATE, @SDATE,
    @DAY_FLG, 'N', 0, '%', @DR_DT,
    @USER_ID, GETDATE(), @USER_ID, GETDATE(), ''      ,@EQP_CD

    DECLARE @IN_SEQ INT = 0
                    
    SET @IN_SEQ = ISNULL((SELECT MAX(A.IN_SEQ)
    FROM PD_RESULT_PROC_SPEC_VALUE_HIS A WITH (NOLOCK)
    WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.IN_DATE = CONVERT(NVARCHAR(10), GETDATE(), 120)            
    ), 0) + 1

    INSERT INTO PD_RESULT_PROC_SPEC_VALUE_HIS
        (
        DIV_CD, PLANT_CD, WC_CD, LINE_CD, PROC_CD,
        IN_DATE,
        IN_SEQ, ORDER_NO, REVISION, RESULT_SEQ, S_CHK,
        CYCLE_SEQ, INSERT_ID, INSERT_DT, UPDATE_ID, UPDATE_DT
        )
    SELECT
        @DIV_CD, @PLANT_CD, @WC_CD, @LINE_CD, @PROC_CD,
        CONVERT(NVARCHAR(10), GETDATE(), 120),
        @IN_SEQ, @ORDER_NO, @REVISION, @RESULT_SEQ, 'Y',
        1, @USER_ID, GETDATE(), @USER_ID, GETDATE()

    INSERT INTO PD_RESULT_PROC_SPEC_VALUE
        (
        DIV_CD, PLANT_CD, ORDER_NO, REVISION, ORDER_TYPE, ORDER_FORM,
        ROUT_NO, ROUT_VER, WC_CD, LINE_CD, PROC_CD, S_CHK, RESULT_SEQ,
        CYCLE_SEQ, SEQ, SPEC_VERSION, PROC_SPEC_CD, EQP_CD, SPEC_VALUE_TYPE,
        SPEC_VALUE, REMARK, INSERT_ID, INSERT_DT, UPDATE_ID, UPDATE_DT,
        IN_DATE, IN_SEQ, GROUP_SPEC_CD
        )

    SELECT A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM,
        A.ROUT_NO, A.ROUT_VER, A.WC_CD, A.LINE_CD, A.PROC_CD, 'Y', @RESULT_SEQ,
        1,--A.RECYCLE_NO,        
        --A.SEQ, 
            ROW_NUMBER() OVER (ORDER BY A.EQP_CD, A.PROC_SPEC_CD),
        
        A.SPEC_VERSION, A.PROC_SPEC_CD, A.EQP_CD, CASE WHEN A.SPEC_VALUE_TYPE = '' THEN '20' ELSE A.SPEC_VALUE_TYPE END,
        CASE WHEN A.SET_FLAG = 'Y' AND
            A.USEM_ITEM_GROUP = '' AND A.PROC_SPEC_VALUE <> '' THEN       
        A.PROC_SPEC_VALUE ELSE     
        CASE WHEN A.PLC_FLAG = 'Y' AND A.AUTO_PLC_FLAG  = 'Y'     
        THEN dbo.USP_OPC_DATA_FMT_CONV_FUNC(A.DIV_CD, A.EQP_CD, BB.OPC_AS + '.' + BB.OPC_AS + '.' + BB.POP_IP_ENO_AS, BB.OPC_AS, BB.POP_IP_ENO)    
        ELSE     
        ''     
        END     
        END       
            
        , '', @USER_ID, GETDATE(), @USER_ID, GETDATE(), CONVERT(NVARCHAR(10), GETDATE(), 120),
        @IN_SEQ, A.GROUP_SPEC_CD
    FROM PD_ORDER_PROC_SPEC_V2 A
        LEFT JOIN POP_EQP_ENO BB ON BB.DIV_CD = @DIV_CD AND BB.PLANT_CD = @PLANT_CD
            AND A.EQP_CD = BB.EQP_CD AND BB.PROC_CD = @PROC_CD AND A.PROC_SPEC_CD = BB.PROC_SPEC_CD

    WHERE A.DIV_CD = @DIV_CD AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM
        AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD
            AND A.InboundId_ApiAutoCreate = (SELECT MAX(InboundId_ApiAutoCreate) FROM PD_ORDER_PROC_SPEC_V2 
            WHERE DIV_CD = @DIV_CD AND PLANT_CD = @PLANT_CD AND ORDER_NO = @ORDEr_NO AND REVISION = @REVISION)
            AND A.SUB_SEQ IS NOT NULL

END TRY 
BEGIN CATCH 
    SET @MSG_CD = '9999'
    SET @MSG_DETAIL = ERROR_MESSAGE()
    RETURN 1 
END CATCH 
--ROLLBACK 