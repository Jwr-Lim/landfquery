/*    
기안번호 : PM250304012    
기안구분 : 일반    
제목 : MES - 생산관리 - 작업실적관리 - 생산실적조회(오더별) - 혼합공정 배정정보 데이터 조회 요청   
일자 : 25.03.13    
작업자 : 임종원 이사    
*/    
ALTER PROC [dbo].[USP_POP_004_RESULT_QUERY6_NEW](      
      
--DECLARE       
        @DIV_CD      NVARCHAR(10) = '01'      
       ,@PLANT_CD    NVARCHAR(10) = '1140'      
       ,@WC_CD       NVARCHAR(10) = '14GC'      
       ,@LINE_CD     NVARCHAR(10) = '14G09C'      
       ,@PROC_CD     NVARCHAR(10) = 'SE'      
       ,@FR_DT       NVARCHAR(10) = '2024-03-03'      
       ,@TO_DT       NVARCHAR(10) = '2024-03-06'      
       ,@EQP_CD      NVARCHAR(50) = ''  
)      
AS      
 
DECLARE @MN_S NVARCHAR(1) = ''  
 
SET @MN_S = ISNULL((SELECT A.MN_S FROM BA_EQP A WITH (NOLOCK)  
WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_CD = @PROC_CD AND A.EQP_CD = @EQP_CD  
 ),'N') 
 
 
DECLARE @TEMP_TBL TABLE 
( 
	 ORDER_NO		NVARCHAR(100) 
	,REVISION		INT 
	,ORDER_TYPE		NVARCHAR(20) 
	,ORDER_FORM		NVARCHAR(20) 
	,ROUT_NO		NVARCHAR(20) 
	,ROUT_VER		INT 
	,RESULT_SEQ		INT 
	,ITEM_CD		NVARCHAR(100) 
	,ITEM_NM		NVARCHAR(50) 
	,LOT_NO			NVARCHAR(100) 
	,RESULT_QTY		NUMERIC(16,4) 
	,GOOD_QTY		NUMERIC(16,4) 
	,ST_CHK			NVARCHAR(2) 
	,S_CHK			NVARCHAR(2) 
	,SIL_DT			DATE 
	,SDATE			NVARCHAR(20) 
	,EDATE			NVARCHAR(20) 
	,DIV_CD			NVARCHAR(20) 
	,PLANT_CD		NVARCHAR(20) 
	,WC_CD			NVARCHAR(20) 
	,LINE_CD		NVARCHAR(20) 
	,PROC_CD		NVARCHAR(20) 
	,PROC_NO		NVARCHAR(100) 
	,EQP_CD			NVARCHAR(20) 
	,DEPARTMENT		NVARCHAR(20) 
	,BTN			NVARCHAR(2) 
) 

INSERT INTO @TEMP_TBL 
    SELECT A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, SUM(C.GOOD_QTY) AS GOOD_QTY,      
	CASE WHEN C.ORDER_NO IS NOT NULL AND A.EDATE IS NOT NULL THEN 'Y' ELSE 'N' END ST_CHK,       
		A.S_CHK, A.SIL_DT, CONVERT(NVARCHAR(20), A.SDATE, 120) AS SDATE, CONVERT(NVARCHAR(20),A.EDATE, 120) AS EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO,       
	CASE WHEN A.WC_CD = '13P'   
	THEN   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP52' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
   
	ELSE    
   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP12' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
	END    
	AS EQP_CD , C.DEPARTMENT, 'N' 
	FROM PD_RESULT A WITH (NOLOCK)       
	INNER JOIN V_ITEM B WITH (NOLOCK) ON A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD       
	LEFT MERGE JOIN PD_ITEM_IN C WITH (NOLOCK) ON       
	A.DIV_CD = C.DIV_CD AND A.PLANT_CD = C.PLANT_CD AND A.ORDER_NO = C.ORDER_NO AND A.REVISION = C.REVISION       
	AND A.ORDER_TYPE = C.ORDER_TYPE AND A.ORDEr_FORM = C.ORDER_FORM AND A.ROUT_NO = C.ROUT_NO AND A.ROUT_VER = C.ROUT_VER       
	AND A.WC_CD = C.WC_CD AND A.LINE_CD = C.LINE_CD AND       
	CASE WHEN dbo.FN_GET_LAST_PROC(A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.PROC_CD) = 'Y' THEN '*' ELSE A.PROC_CD END = C.PROC_CD      
	AND A.RESULT_SEQ = C.RESULT_SEQ AND A.S_CHK = C.S_CHK       
	WHERE       
	A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 
    
	--CONVERT(NVARCHAR(10), A.SDATE, 120)     
	AND A.SIL_DT     
	BETWEEN @FR_DT AND @TO_DT      
	AND CASE WHEN @MN_S <> 'N' THEN A.EQP_CD ELSE @EQP_CD END = @EQP_CD  
    AND A.S_CHK = 'N'
	GROUP BY A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, A.S_CHK, A.SDATE, A.EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO, C.ORDER_NO, A.EQP_CD, A.RK_DATE      
	, C.DEPARTMENT, A.SIL_DT 
    UNION ALL 
    SELECT A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, SUM(C.GOOD_QTY) AS GOOD_QTY,      
	CASE WHEN C.ORDER_NO IS NOT NULL AND A.EDATE IS NOT NULL THEN 'Y' ELSE 'N' END ST_CHK,       
		A.S_CHK, A.SIL_DT, CONVERT(NVARCHAR(20), A.SDATE, 120) AS SDATE, CONVERT(NVARCHAR(20),A.EDATE, 120) AS EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO,       
	CASE WHEN A.WC_CD = '13P'   
	THEN   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP52' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
   
	ELSE    
   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP12' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
	END    
	AS EQP_CD , C.DEPARTMENT, 'N' 
	FROM PD_RESULT A WITH (NOLOCK)       
	INNER JOIN V_ITEM B WITH (NOLOCK) ON A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD       
	LEFT MERGE JOIN PD_ITEM_IN C WITH (NOLOCK) ON       
	A.DIV_CD = C.DIV_CD AND A.PLANT_CD = C.PLANT_CD AND A.ORDER_NO = C.ORDER_NO AND A.REVISION = C.REVISION       
	AND A.ORDER_TYPE = C.ORDER_TYPE AND A.ORDEr_FORM = C.ORDER_FORM AND A.ROUT_NO = C.ROUT_NO AND A.ROUT_VER = C.ROUT_VER       
	AND A.WC_CD = C.WC_CD AND A.LINE_CD = C.LINE_CD AND       
	CASE WHEN dbo.FN_GET_LAST_PROC(A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.PROC_CD) = 'Y' THEN '*' ELSE A.PROC_CD END = C.PROC_CD      
	AND A.RESULT_SEQ = C.RESULT_SEQ AND A.S_CHK = C.S_CHK       
	WHERE       
	A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 
    
	--CONVERT(NVARCHAR(10), A.SDATE, 120)     
	AND A.SIL_DT     
	BETWEEN @FR_DT AND @TO_DT      
	--AND CASE WHEN @MN_S <> 'N' THEN A.EQP_CD ELSE @EQP_CD END = @EQP_CD  
    AND A.S_CHK = 'Y'
	GROUP BY A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, A.S_CHK, A.SDATE, A.EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO, C.ORDER_NO, A.EQP_CD, A.RK_DATE      
	, C.DEPARTMENT, A.SIL_DT 


SELECT *FROM @TEMP_TBL

ORDER BY SDATE DESC, LOT_NO DESC
/*
DECLARE	@DC_I			INT = 0 
	   ,@DC_CNT			INT = 0 
	   ,@DC_ORDER_NO	NVARCHAR(50) = '' 
	   ,@DC_RESULT_SEQ	INT 
	   ,@BTN			NVARCHAR(2) = 'N' 
 
SET @DC_CNT = (SELECT COUNT(*) 
			   FROM PD_RESULT WITH(NOLOCK) 
			   WHERE DIV_CD = @DIV_CD 
			     AND PLANT_CD = @PLANT_CD 
			     AND WC_CD = @WC_CD 
			     AND LINE_CD = @LINE_CD 
			     AND PROC_CD = @PROC_CD 
			     AND SIL_DT BETWEEN @FR_DT AND @TO_DT) 
 
 
WHILE (1=1) 
 
BEGIN 
 
	SET @DC_I = @DC_I + 1 
	 
	SET @DC_RESULT_SEQ = (SELECT TOP 1 A.RESULT_SEQ 
						  FROM 
						  ( 
							SELECT DIV_CD, PLANT_CD, WC_CD, LINE_CD, PROC_CD, SIL_DT, RESULT_SEQ, 
								   ROW_NUMBER() OVER (ORDER BY RESULT_SEQ) AS ROWNUM 
							FROM PD_RESULT WITH(NOLOCK) 
							WHERE DIV_CD = @DIV_CD 
						    AND PLANT_CD = @PLANT_CD 
						    AND WC_CD = @WC_CD 
						    AND LINE_CD = @LINE_CD 
						    AND PROC_CD = @PROC_CD 
						    AND SIL_DT BETWEEN @FR_DT AND @TO_DT 
						  ) A 
						  WHERE A.ROWNUM = @DC_I 
						  ORDER BY RESULT_SEQ) 
 
 
	SET @DC_ORDER_NO = (SELECT ORDER_NO 
						FROM PD_RESULT WITH(NOLOCK) 
						WHERE DIV_CD = @DIV_CD 
						  AND PLANT_CD = @PLANT_CD 
						  AND WC_CD = @WC_CD 
						  AND LINE_CD = @LINE_CD 
						  AND PROC_CD = @PROC_CD 
						  AND SIL_DT BETWEEN @FR_DT AND @TO_DT 
						  AND RESULT_SEQ = @DC_RESULT_SEQ) 
 
 
	IF EXISTS (SELECT 1 
				   FROM PD_RESULT A WITH (NOLOCK)  
				   INNER JOIN PD_RESULT_PROC_SPEC_VALUE B WITH (NOLOCK) 
				   ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDEr_NO = B.ORDER_NO AND A.REVISION = B.REVISION  
				   AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD  
				   AND A.LINE_CD = B.LINE_CD AND A.PROC_CD =B.PROC_CD AND A.RESULT_SEQ = B.RESULT_SEQ  
				   INNER JOIN PD_ORDER_PROC_SPEC_V2 C WITH (NOLOCK)  
				   ON B.DIV_CD = C.DIV_CD AND B.PLANT_CD = C.PLANT_CD AND B.ORDER_NO = C.ORDER_NO AND B.REVISION = C.REVISION  
				   AND B.ORDER_TYPE = C.ORDER_TYPE AND B.ORDER_FORM = C.ORDER_FORM AND B.ROUT_NO = C.ROUT_NO AND B.ROUT_VER = C.ROUT_VER AND B.WC_CD = C.WC_CD  
				   AND B.LINE_CD = C.LINE_CD AND B.PROC_CD = C.PROC_CD AND B.PROC_SPEC_CD = C.PROC_SPEC_CD AND B.EQP_CD = C.EQP_CD  
				   AND C.REQ_FLAG = 'Y' 
				   INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON B.PROC_SPEC_CD = D.SUB_CD AND D.MAIN_CD = 'P2001' 
				   WHERE A.ORDER_NO = @DC_ORDER_NO AND A.PROC_CD = @PROC_CD AND A.RESULT_SEQ = @DC_RESULT_SEQ 
				     AND ISNULL(B.SPEC_VALUE,'') <> '') 
	BEGIN 
		SET @BTN = 'Y' 
	END 
 
	INSERT INTO @TEMP_TBL 
	SELECT A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, SUM(C.GOOD_QTY) AS GOOD_QTY,      
	CASE WHEN C.ORDER_NO IS NOT NULL AND A.EDATE IS NOT NULL THEN 'Y' ELSE 'N' END ST_CHK,       
		A.S_CHK, A.SIL_DT, CONVERT(NVARCHAR(20), A.SDATE, 120) AS SDATE, CONVERT(NVARCHAR(20),A.EDATE, 120) AS EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO,       
	CASE WHEN A.WC_CD = '13P'   
	THEN   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP52' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
   
	ELSE    
   
	ISNULL((SELECT A.RK_DATE + ' ' + SUB_NM FROM BA_SUB_CD WITH (NOLOCK) WHERE MAIN_CD = 'POP12' AND SUB_CD = A.EQP_CD),A.EQP_CD)    
	END    
	AS EQP_CD , C.DEPARTMENT, @BTN 
	FROM PD_RESULT A WITH (NOLOCK)       
	INNER JOIN V_ITEM B WITH (NOLOCK) ON A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD       
	LEFT MERGE JOIN PD_ITEM_IN C WITH (NOLOCK) ON       
	A.DIV_CD = C.DIV_CD AND A.PLANT_CD = C.PLANT_CD AND A.ORDER_NO = C.ORDER_NO AND A.REVISION = C.REVISION       
	AND A.ORDER_TYPE = C.ORDER_TYPE AND A.ORDEr_FORM = C.ORDER_FORM AND A.ROUT_NO = C.ROUT_NO AND A.ROUT_VER = C.ROUT_VER       
	AND A.WC_CD = C.WC_CD AND A.LINE_CD = C.LINE_CD AND       
	CASE WHEN dbo.FN_GET_LAST_PROC(A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.PROC_CD) = 'Y' THEN '*' ELSE A.PROC_CD END = C.PROC_CD      
	AND A.RESULT_SEQ = C.RESULT_SEQ AND A.S_CHK = C.S_CHK       
	WHERE       
	A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.RESULT_SEQ = @DC_RESULT_SEQ AND 
    
	--CONVERT(NVARCHAR(10), A.SDATE, 120)     
	A.SIL_DT     
	BETWEEN @FR_DT AND @TO_DT      
	AND CASE WHEN @MN_S <> 'N' THEN A.EQP_CD ELSE @EQP_CD END = @EQP_CD  
 
	GROUP BY A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, A.RESULT_SEQ, A.ITEM_CD, B.ITEM_NM, A.LOT_NO,       
	A.RESULT_QTY, A.S_CHK, A.SDATE, A.EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO, C.ORDER_NO, A.EQP_CD, A.RK_DATE      
	, C.DEPARTMENT, A.SIL_DT 
	--ORDER BY A.SDATE DESC, A.LOT_NO DESC  
 
	IF @DC_I >= @DC_CNT BREAK 
 
END 
 
SELECT * 
FROM @TEMP_TBL 
ORDER BY SDATE DESC, LOT_NO DESC
*/