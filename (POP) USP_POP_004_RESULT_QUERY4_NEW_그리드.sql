ALTER PROC [dbo].[USP_POP_004_RESULT_QUERY4_NEW]( 
      @DIV_CD       NVARCHAR(10) = ''   
    ,@PLANT_CD     NVARCHAR(10) = ''  
    ,@ORDER_NO     NVARCHAR(50) = ''  
    ,@REVISION     INT   
    ,@ORDER_TYPE   NVARCHAR(10) = ''  
    ,@ORDER_FORM   NVARCHAR(10) = ''  
    ,@ROUT_NO      NVARCHAR(50) = ''  
    ,@ROUT_VER     INT   
    ,@WC_CD        NVARCHAR(10) = ''  
    ,@LINE_CD      NVARCHAR(10) = ''  
    ,@PROC_CD      NVARCHAR(10) = ''  
    ,@S_CHK        NVARCHAr(1)   
    ,@RESULT_SEQ   INT   
)
AS
SET NOCOUNT ON 


SELECT 'False' as CHK, A.ORDER_NO, A.REVISION, A.ORDER_TYPE, A.ORDER_FORM, A.ROUT_NO, A.ROUT_VER, ISNULL(B.SEQ,1) AS SEQ,  A.RESULT_SEQ, A.ITEM_CD, A1.ITEM_NM, A.LOT_NO, 
    
    CASE WHEN dbo.FN_GET_LAST_PROC(A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.PROC_CD) = 'Y' THEN B.BARCODE ELSE B.LOT_NO END AS 
    BARCODE, 
    CASE WHEN B.ORDER_NO IS NOT NULL THEN A.RESULT_QTY ELSE A.RESULT_QTY END AS RESULT_QTY, B.GOOD_QTY,
  
    CASE WHEN B.ORDER_NO IS NOT NULL AND A.EDATE IS NOT NULL THEN 'Y' ELSE 'N' END ST_CHK, 
    A.S_CHK, A.SDATE, A.EDATE, A.DIV_CD, A.PLANT_CD, A.WC_CD, A.LINE_CD, A.PROC_CD, A.PROC_NO,
	CASE WHEN C.DIV_CD IS NOT NULL THEN 'Y' ELSE 'N' END AS PRINT_YN
FROM PD_RESULT A WITH (NOLOCK) 
INNER JOIN V_ITEM A1 WITH (NOLOCK) ON A.PLANT_CD = A1.PLANT_CD AND A.ITEM_CD = A1.ITEM_CD 
LEFT JOIN PD_ITEM_IN B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION AND A.ORDER_TYPE = B.ORDER_TYPE 
 AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LINE_CD 
 AND CASE WHEN dbo.FN_GET_LAST_PROC(A.DIV_CD, A.PLANT_CD, A.ORDER_NO, A.REVISION, A.PROC_CD) = 'Y' THEN '*' ELSE A.PROC_CD END = B.PROC_CD
 AND A.RESULT_SEQ = B.RESULT_SEQ 
LEFT OUTER JOIN
(
	SELECT	DIV_CD		,PLANT_CD		,PROC_NO	,ORDER_NO
			,REVISION	,ORDER_TYPE		,ORDER_FORM	,ROUT_NO
			,ROUT_VER	,WC_CD			,LINE_CD	,PROC_CD
			,S_CHK		,RESULT_SEQ		,SEQ
	FROM PD_RESULT_PACK_PRINT (NOLOCK)
	GROUP BY DIV_CD,PLANT_CD,PROC_NO,ORDER_NO,REVISION,ORDER_TYPE,ORDER_FORM,ROUT_NO
			,ROUT_VER,WC_CD,LINE_CD,PROC_CD,S_CHK,RESULT_SEQ,SEQ
) C
 ON B.DIV_CD = C.DIV_CD
 AND B.PLANT_CD = C.PLANT_CD
 AND B.PROC_NO = C.PROC_NO
 AND B.ORDER_NO = C.ORDER_NO
 AND B.REVISION = C.REVISION
 AND B.ORDER_TYPE = C.ORDER_TYPE
 AND B.ORDER_FORM = C.ORDER_FORM
 AND B.ROUT_NO = C.ROUT_NO
 AND B.ROUT_VER = C.ROUT_VER
 AND B.WC_CD = C.WC_CD
 AND B.LINE_CD = C.LINE_CD
 AND A.PROC_CD = C.PROC_CD
 AND B.S_CHK = C.S_CHK
 AND B.RESULT_SEQ = C.RESULT_SEQ
 AND B.SEQ = C.SEQ
WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD 
  AND A.ORDER_NO = @ORDEr_NO AND A.REVISION = @REVISION AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM 
  AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER
  AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 
  AND A.S_CHK = @S_CHK AND A.RESULT_SEQ = @RESULT_SEQ  
  
ORDER BY A.INSERT_dT DESC, A.RESULT_SEQ, B.SEQ 

