ALTER PROC USP_POP_004_RESULT_NEW_QUERY2 (
--DECLARE 
     @DIV_CD         NVARCHAR(10)   =''
    ,@PLANT_CD       NVARCHAR(10)   =''
    ,@PROC_NO        NVARCHAR(50)   =''
    ,@ORDER_NO       NVARCHAR(50)   =''
    ,@REVISION       INT            =0
    ,@ORDER_TYPE     NVARCHAR(10)   =''
    ,@ORDER_FORM     NVARCHAR(10)   ='' 
    ,@ROUT_NO        NVARCHAR(10)   ='' 
    ,@ROUT_VER       INT            =0
    ,@WC_CD          NVARCHAR(20)   ='' 
    ,@LINE_CD        NVARCHAR(20)   =''
    ,@PROC_CD        NVARCHAR(10)   =''
    ,@EQP_CD         NVARCHAR(50)   =''
    ,@RESULT_SEQ     INT            = 0

)-- WITH RECOMPILE
AS 


SET NOCOUNT ON 
-- 1. 그룹이 아닌 경우 재공 처리
-- 2. 이부분은 앞공정 그대로 가지고 오면 될것 같음. 내 보다 앞공정의 재공이 있는 경우만 판단한다.

/*
해당 오더의 기준으로 @PROC_CD 가 최초이면? 자기 자신 즉 PD_USEM 처리 
아니면 앞에 재공이 있는 공정이면 무조건 표기

*/
DECLARE @MAT_TABLE TABLE (              
   CNT               INT IDENTITY(1,1)              
  ,GU                NVARCHAR(10)               
  ,BASE_ITEM_NM      NVARCHAR(50)               
  ,ITEM_CD           NVARCHAR(50)              
  ,ITEM_NM           NVARCHAR(50)               
  ,LOT_NO            NVARCHAR(50)               
  ,SL_NM             NVARCHAR(10)               
  ,QTY               NUMERIC(18,3)               
  ,STOCK_QTY         NUMERIC(18,3)               
  ,USEM_QTY          NUMERIC(18,3)               
  ,PLC_QTY           NUMERIC(18,3)               
  ,BATCH_CHK         NVARCHAR(10)               
  ,USEM_SEQ          INT               
  ,ORDER_NO          NVARCHAR(50)               
  ,REVISION          INT               
  ,RESULT_SEQ        INT               
  ,PROC_CD           NVARCHAR(10)               
  ,GBN               NVARCHAR(10)               
  ,IN_DATE           NVARCHAR(10)               
  ,IN_SEQ            INT               
  ,REP_ITEM_CD       NVARCHAR(50)               
  ,ITEM_ACCT         NVARCHAR(10)              
  ,SPECIPI_QTY       NUMERIC(18,3)               
  ,EQP_CD            NVARCHAR(50)             
  ,DEPARTMENT        NVARCHAR(50)    
  ,IDX_DT            NVARCHAR(10) 
  ,IDX_SEQ           INT 
)              
              

DECLARE @NOW_GROUP_SEQ INT = 0
  -- 근데 내가 투입이면? 
DECLARE @IN_CHK   NVARCHAR(10) = ''
        ,@OUT_CHK  NVARCHAR(10) = '' 
        ,@MN_S     NVARCHAR(1) = 'N'

SELECT @IN_CHK = A.IN_CHK, @OUT_CHK = A.OUT_CHK FROM PD_ORDER_PROC A WITH (NOLOCK) 
WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
  AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
  AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 

SELECT @NOW_GROUP_SEQ = A.GROUP_SEQ FROM PD_ORDER_PROC A WITH (NOLOCK) 
WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
  AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
  AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 
ORDER BY A.GROUP_SEQ 

SET @MN_S = ISNULL((SELECT A.MN_S FROM BA_EQP A WITH (NOLOCK) 
WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.EQP_CD = @EQP_CD and A.PROC_CD = @PROC_CD),'N')


--IF NOT EXISTS(SELECT *FROM PD_ORDER_PROC A WITH (NOLOCK) 
--WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.GROUP_SEQ < @NOW_GROUP_SEQ

IF @IN_CHK = 'Y' AND @OUT_CHK = 'N'
BEGIN 
    -- 최초니까 내껏만 있으면 된다.
    --SELECT '1'
    -- 배정이 있으면 I, 없으면 J
    SELECT 
    CASE WHEN EXISTS(SELECT *FROM MT_ITEM_OUT_BATCH A1 WITH (NOLOCK) 
    WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.REQ_NO = B.REQ_NO) THEN 'I' ELSE 'Z' END AS GU
    ,D.SUB_NM AS BASE_ITEM_NM
    ,B.ITEM_CD 
    ,C.ITEM_NM 
    ,B.LOT_NO 
    ,'' AS SL_NM
    ,0 AS QTY
    ,0 AS STOCK_QTY 
    ,ISNULL(B.USEM_QTY,0) AS USEM_QTY 
    ,ISNULL(B.PLC_QTY,0) AS PLC_QTY 
    -- 배정(Y), 소분(S), 일반(N) 으로 구분 BATCH_CHK
    ,CASE WHEN EXISTS(SELECT *FROM MT_ITEM_OUT_BATCH A1 WITH (NOLOCK) 
     WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.REQ_NO = B.REQ_NO) THEN 'Y' ELSE 
     CASE WHEN EXISTS(SELECT *FROM MT_ITEM_OUT_BATCH_SU B1 WITH (NOLOCK) 
     WHERE B1.DIV_CD = A.DIV_CD AND B1.PLANT_CD = A.PLANT_CD AND B1.REQ_NO = B.REQ_NO) THEN 'S' ELSE 
     'N' END END AS BATCH_CHK
    ,B.USEM_SEQ
    ,B.ORDER_NO
    ,B.REVISION
    ,A.RESULT_SEQ
    ,A.PROC_CD
    ,'N' AS GBN 
    ,C.REP_ITEM_CD 
    ,0 AS SPECIPI_QTY 
    ,A.EQP_CD 
    ,RIGHT(B.REQ_DT,2) + '-' + dbo.LPAD(B.PLAN_SEQ, 3,0) + 
      CASE WHEN ISNULL(B.BATCH_NO,'') = '' THEN '' ELSE '-' + 
      CAST(B.BATCH_NO AS NVARCHAR) END AS DEPARTMENT

    FROM PD_RESULT A WITH (NOLOCK) 
    INNER JOIN PD_USEM B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.PROC_NO = B.PROC_NO 
    AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM 
    AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LINE_CD AND A.PROC_CD = B.PROC_CD 
    AND A.RESULT_SEQ = B.RESULT_SEQ 
    INNER JOIN V_ITEM C WITH (NOLOCK) ON B.PLANT_CD = C.PLANT_CD AND B.ITEM_CD = C.ITEM_CD 
    INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON C.BASE_ITEM_CD = D.SUB_CD AND D.MAIN_CD = 'BA206'

    WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
      AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
      AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'N' AND A.RESULT_SEQ = @RESULT_SEQ 
      
END 
ELSE
BEGIN 
--    SELECT '2'

  DECLARE @RESULT_PROC TABLE (
     WC_CD   NVARCHAR(10)
    ,LINE_CD NVARCHAR(10) 
    ,PROC_CD NVARCHAR(50) 
    ,ORDER_NO NVARCHAR(50)
    ,OUT_CHK  NVARCHAR(1) 
    ,IN_CHK   NVARCHAR(1)
  )

  DECLARE @OUT_SEQ INT = 0 

  SET @OUT_SEQ = ISNULL((SELECT TOP 1 A.GROUP_SEQ FROM PD_ORDER_PROC A WITH (NOLOCK) 
  WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.GROUP_SEQ < @NOW_GROUP_SEQ
    AND A.OUT_CHK = 'Y'
  ORDER BY A.GROUP_SEQ DESC),0)  
  -- 앞공정에 실적이 있는가? 
  -- 그러면 앞공정부터 현공정까지 실적 및 투입까지 다 가지고 온다. 

  -- 실적이 하나도 없으면 투입은 있는가? 
  IF @OUT_SEQ = 0
  BEGIN 
    SET @OUT_SEQ = ISNULL((SELECT TOP 1 A.GROUP_SEQ FROM PD_ORDER_PROC A WITH (NOLOCK) 
    WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.GROUP_SEQ < @NOW_GROUP_SEQ
    AND A.IN_CHK = 'Y'
    ORDER BY A.GROUP_SEQ),99)
  END 

  IF @MN_S = 'E' 
  BEGIN 
      INSERT INTO @RESULT_PROC 
      SELECT TOP 1 A.WC_CD, A.LINE_CD, A.PROC_CD, A.ORDER_NO, A.OUT_CHK, A.IN_CHK  FROM PD_ORDER_PROC A WITH (NOLOCK) 
      WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.GROUP_SEQ BETWEEN @OUT_SEQ AND @NOW_GROUP_SEQ 
      ORDER BY A.PROC_SEQ DESC 
  END 
  ELSE 
  BEGIN 

      INSERT INTO @RESULT_PROC 
      SELECT A.WC_CD, A.LINE_CD, A.PROC_CD, A.ORDER_NO, A.OUT_CHK, A.IN_CHK  FROM PD_ORDER_PROC A WITH (NOLOCK) 
      WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.GROUP_SEQ BETWEEN @OUT_SEQ AND @NOW_GROUP_SEQ - 1
  
  END 

  --SELECT *FROM @RESULT_PROC 


  IF EXISTS(SELECT *FROM @RESULT_PROC)
  BEGIN 

    /*
    SELECT DISTINCT
    AA.GU, 
    AA.BASE_ITEM_NM,
    AA.ITEM_CD, 
    AA.ITEM_NM, 
    AA.LOT_NO, 
    AA.SL_NM, 
    AA.QTY, 
    AA.STOCK_QTY, 
    AA.USEM_QTY, 
    AA.PLC_QTY,
    AA.BATCH_CHK,
    AA.USEM_SEQ, 
    AA.ORDEr_NO, 
    AA.REVISION, 
    AA.RESULT_SEQ, 
    AA.PROC_CD, 
    AA.REP_ITEM_CD, 
    AA.DEPARTMENT,
    AA.IDX_DT, AA.IDX_SEQ
    FROM 
    (*/
/*    
    IF 
    EXISTS(SELECT *
      FROM @RESULT_PROC
    WHERE (SELECT COUNT(DISTINCT ORDER_NO) FROM @RESULT_PROC) > 1
    )
*/
    IF @LINE_CD = '13G01B' AND @PROC_CD = 'MX'
    BEGIN 

      INSERT INTO @MAT_TABLE (
        GU, BASE_ITEM_NM, 
        ITEM_CD, ITEM_NM, LOT_NO, SL_NM, QTY, STOCK_QTY, USEM_QTY, PLC_QTY, 
        BATCH_CHK, USEM_SEQ, ORDER_NO, REVISION, RESULT_SEQ, PROC_CD, REP_ITEM_CD, DEPARTMENT,
        IDX_DT, IDX_SEQ
      )
      SELECT 'Z' AS GU, 
      D.SUB_NM AS BASE_ITEM_NM,
      A.ITEM_CD,
      C.ITEM_NM,
      A.LOT_NO,
      '' AS SL_NM,
      A.GOOD_QTY 
      - 
      ISNULL((SELECT SUM(USEM_QTY) FROM PD_USEM A1 WITH (NOLOCK) 
      WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.ITEM_CD = A.ITEM_CD AND A1.LOT_NO = A.LOT_NO 
        AND A1.BE_ORDER_NO = A.ORDER_NO AND A1.BE_REVISION = A.REVISION AND A1.BE_RESULT_SEQ = A.RESULT_SEQ AND A1.BE_PROC_CD = A.PROC_CD 
      ),0)
      - (ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_IN AA WITH (NOLOCK)                                    
      WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND AA.LOCATION_NO = A.LOCATION_NO                                    
      AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                  
      AND AA.MOVE_TYPE IN ('SR','506','503','311','601')                                  
      ),0) 
      -                                    
      ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_OUT AA WITH (NOLOCK)                                    
      WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND  AA.LOCATION_NO = A.LOCATION_NO                                  
      AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                 
      AND AA.MOVE_TYPE IN ('SI' ,'506','503','311','601')                                  
      ),0)
      )
      AS QTY, -- 중요 부분 
      B.QTY AS STOCK_QTY,
      ISNULL(E.USEM_QTY,0) AS USEM_QTY,
      ISNULL(E.PLC_QTY,0) AS PLC_QTY,
      'N' AS BATCH_CHK, 
      0 AS USEM_SEQ, 
      E.BE_ORDER_NO AS ORDER_NO,
      E.BE_REVISION AS REVISION, 
      E.BE_RESULT_SEQ AS RESULT_SEQ,
      E.BE_PROC_CD AS PROC_CD,
      C.REP_ITEM_CD,
      A.DEPARTMENT,
      A.IDX_DT, A.IDX_SEQ
      FROM PD_ITEM_IN A WITH (NOLOCK)
      INNER JOIN @RESULT_PROC A1 ON A.WC_CD = A1.WC_CD AND A.LINE_CD = A1.LINE_CD AND A.PROC_CD = A1.PROC_CD 
      INNER JOIN ST_STOCK_NOW B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD 
      AND A.LOT_NO = B.LOT_NO AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LOCATION_NO AND A.PROC_CD = B.PROC_CD AND B.QTY > 0
      INNER JOIN V_ITEM C WITH (NOLOCK) ON A.PLANT_CD = C.PLANT_CD AND A.ITEM_CD = C.ITEM_CD 
      INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON C.BASE_ITEM_CD = D.SUB_CD AND D.MAIN_CD = 'BA206'
      
      LEFT JOIN 
      (
        SELECT B.ITEM_CD, B.LOT_NO, SUM(B.USEM_QTY) AS USEM_QTY, SUM(B.PLC_QTY) AS PLC_QTY, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD 
        FROM PD_RESULT A WITH (NOLOCK) 
        INNER JOIN PD_USEM B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION 
        AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD 
        AND A.LINE_CD = B.LINE_CD AND A.PROC_CD = B.PROC_CD AND A.RESULT_SEQ = B.RESULT_SEQ 
      WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
        AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
        AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'N' AND A.RESULT_SEQ = @RESULT_SEQ 
        GROUP BY B.ITEM_CD, B.LOT_NO, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD

      ) E ON A.ITEM_CD = E.ITEM_CD AND A.LOT_NO = E.LOT_NO AND A.ORDER_NO = E.BE_ORDER_NO AND A.REVISION = E.BE_REVISION AND A.RESULT_SEQ = E.BE_RESULT_SEQ
          AND A.PROC_CD = E.BE_PROC_CD    
          WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.DEPARTMENT IN (
            SELECT A.EQP_CD FROM PD_ORDER_PROC_SPEC A WITH (NOLOCK) 
            WHERE A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD 
              AND A.USEM_ITEM_GROUP <> ''
      )

      INSERT INTO @MAT_TABLE (
        GU, BASE_ITEM_NM, 
        ITEM_CD, ITEM_NM, LOT_NO, SL_NM, QTY, STOCK_QTY, USEM_QTY, PLC_QTY, 
        BATCH_CHK, USEM_SEQ, ORDER_NO, REVISION, RESULT_SEQ, PROC_CD, REP_ITEM_CD, DEPARTMENT,
        IDX_DT, IDX_SEQ
      )
      SELECT 'Z' AS GU, 
      D.SUB_NM AS BASE_ITEM_NM,
      A.ITEM_CD,
      C.ITEM_NM,
      A.LOT_NO,
      '' AS SL_NM,
      A.GOOD_QTY 
      - 
      ISNULL((SELECT SUM(USEM_QTY) FROM PD_USEM A1 WITH (NOLOCK) 
      WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.ITEM_CD = A.ITEM_CD AND A1.LOT_NO = A.LOT_NO 
        AND A1.BE_ORDER_NO = A.ORDER_NO AND A1.BE_REVISION = A.REVISION AND A1.BE_RESULT_SEQ = A.RESULT_SEQ AND A1.BE_PROC_CD = A.PROC_CD 
      ),0)
      - (ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_IN AA WITH (NOLOCK)                                    
      WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND AA.LOCATION_NO = A.LOCATION_NO                                    
      AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                  
      AND AA.MOVE_TYPE IN ('SR','506','503','311','601')                                  
      ),0) 
      -                                    
      ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_OUT AA WITH (NOLOCK)                                    
      WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND  AA.LOCATION_NO = A.LOCATION_NO                                  
      AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                 
      AND AA.MOVE_TYPE IN ('SI' ,'506','503','311','601')                                  
      ),0)
      )
      AS QTY, -- 중요 부분 
      B.QTY AS STOCK_QTY,
      ISNULL(E.USEM_QTY,0) AS USEM_QTY,
      ISNULL(E.PLC_QTY,0) AS PLC_QTY,
      'N' AS BATCH_CHK, 
      0 AS USEM_SEQ, 
      E.BE_ORDER_NO AS ORDER_NO,
      E.BE_REVISION AS REVISION, 
      E.BE_RESULT_SEQ AS RESULT_SEQ,
      E.BE_PROC_CD AS PROC_CD,
      C.REP_ITEM_CD,
      A.DEPARTMENT,
      A.IDX_DT, A.IDX_SEQ
      FROM PD_ITEM_IN A WITH (NOLOCK)
      INNER JOIN @RESULT_PROC A1 ON A.WC_CD = A1.WC_CD AND A.LINE_CD = A1.LINE_CD AND A.PROC_CD = A1.PROC_CD 
      INNER JOIN ST_STOCK_NOW B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD 
      AND A.LOT_NO = B.LOT_NO AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LOCATION_NO AND A.PROC_CD = B.PROC_CD AND B.QTY > 0
      INNER JOIN V_ITEM C WITH (NOLOCK) ON A.PLANT_CD = C.PLANT_CD AND A.ITEM_CD = C.ITEM_CD 
      INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON C.BASE_ITEM_CD = D.SUB_CD AND D.MAIN_CD = 'BA206'
      
      LEFT JOIN 
      (
        SELECT B.ITEM_CD, B.LOT_NO, SUM(B.USEM_QTY) AS USEM_QTY, SUM(B.PLC_QTY) AS PLC_QTY, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD 
        FROM PD_RESULT A WITH (NOLOCK) 
        INNER JOIN PD_USEM B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION 
        AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD 
        AND A.LINE_CD = B.LINE_CD AND A.PROC_CD = B.PROC_CD AND A.RESULT_SEQ = B.RESULT_SEQ 
      WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
        AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
        AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'N' AND A.RESULT_SEQ = @RESULT_SEQ 
        GROUP BY B.ITEM_CD, B.LOT_NO, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD

      ) E ON A.ITEM_CD = E.ITEM_CD AND A.LOT_NO = E.LOT_NO AND A.ORDER_NO = E.BE_ORDER_NO AND A.REVISION = E.BE_REVISION AND A.RESULT_SEQ = E.BE_RESULT_SEQ
          AND A.PROC_CD = E.BE_PROC_CD    
          WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.LINE_CD = @LINE_CD 
            



    END 
    ELSE 
    BEGIN 
      INSERT INTO @MAT_TABLE (
        GU, BASE_ITEM_NM, 
        ITEM_CD, ITEM_NM, LOT_NO, SL_NM, QTY, STOCK_QTY, USEM_QTY, PLC_QTY, 
        BATCH_CHK, USEM_SEQ, ORDER_NO, REVISION, RESULT_SEQ, PROC_CD, REP_ITEM_CD, DEPARTMENT,
        IDX_DT, IDX_SEQ
      )
        SELECT 'Z' AS GU, 
        D.SUB_NM AS BASE_ITEM_NM,
        A.ITEM_CD,
        C.ITEM_NM,
        A.LOT_NO,
        '' AS SL_NM,
        A.GOOD_QTY 
        - 
        ISNULL((SELECT SUM(USEM_QTY) FROM PD_USEM A1 WITH (NOLOCK) 
        WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.ITEM_CD = A.ITEM_CD AND A1.LOT_NO = A.LOT_NO 
          AND A1.BE_ORDER_NO = A.ORDER_NO AND A1.BE_REVISION = A.REVISION AND A1.BE_RESULT_SEQ = A.RESULT_SEQ AND A1.BE_PROC_CD = A.PROC_CD 
        ),0)
        - (ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_IN AA WITH (NOLOCK)                                    
        WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND AA.LOCATION_NO = A.LOCATION_NO                                    
        AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                  
        AND AA.MOVE_TYPE IN ('SR','506','503','311','601')                                  
        ),0) 
        -                                    
        ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_OUT AA WITH (NOLOCK)                                    
        WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND  AA.LOCATION_NO = A.LOCATION_NO                                  
        AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                 
        AND AA.MOVE_TYPE IN ('SI' ,'506','503','311','601')                                  
        ),0)
        )
        AS QTY, -- 중요 부분 
        B.QTY AS STOCK_QTY,
        ISNULL(E.USEM_QTY,0) AS USEM_QTY,
        ISNULL(E.PLC_QTY,0) AS PLC_QTY,
        'N' AS BATCH_CHK, 
        0 AS USEM_SEQ, 
        E.BE_ORDER_NO AS ORDER_NO,
        E.BE_REVISION AS REVISION, 
        E.BE_RESULT_SEQ AS RESULT_SEQ,
        E.BE_PROC_CD AS PROC_CD,
        C.REP_ITEM_CD,
        A.DEPARTMENT,
        A.IDX_DT, A.IDX_SEQ
        FROM PD_ITEM_IN A WITH (NOLOCK)
        INNER JOIN @RESULT_PROC A1 ON A.WC_CD = A1.WC_CD AND A.LINE_CD = A1.LINE_CD AND A.PROC_CD = A1.PROC_CD 

        INNER JOIN ST_STOCK_NOW B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD 
        AND A.LOT_NO = B.LOT_NO AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LOCATION_NO AND A.PROC_CD = B.PROC_CD AND B.QTY = 0
        INNER JOIN V_ITEM C WITH (NOLOCK) ON A.PLANT_CD = C.PLANT_CD AND A.ITEM_CD = C.ITEM_CD 
        INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON C.BASE_ITEM_CD = D.SUB_CD AND D.MAIN_CD = 'BA206'
        INNER JOIN 
        (
          SELECT B.ITEM_CD, B.LOT_NO, SUM(B.USEM_QTY) AS USEM_QTY, SUM(B.PLC_QTY) AS PLC_QTY, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD 
          FROM PD_RESULT A WITH (NOLOCK) 
          INNER JOIN PD_USEM B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION 
          AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD 
          AND A.LINE_CD = B.LINE_CD AND A.PROC_CD = B.PROC_CD AND A.RESULT_SEQ = B.RESULT_SEQ 
        WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
          AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
          AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'N' AND A.RESULT_SEQ = @RESULT_SEQ 
          GROUP BY B.ITEM_CD, B.LOT_NO, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD

        ) E ON A.ITEM_CD = E.ITEM_CD AND A.LOT_NO = E.LOT_NO AND A.ORDER_NO = E.BE_ORDER_NO AND A.REVISION = E.BE_REVISION AND A.RESULT_SEQ = E.BE_RESULT_SEQ
        AND A.PROC_CD = E.BE_PROC_CD    
        WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD 
          AND A.ORDER_NO <> 'PD250113003'
  --     AND A.PROC_CD IN (SELECT PROC_CD FROM @RESULT_PROC)
        
        INSERT INTO @MAT_TABLE (
        GU, BASE_ITEM_NM, 
        ITEM_CD, ITEM_NM, LOT_NO, SL_NM, QTY, STOCK_QTY, USEM_QTY, PLC_QTY, 
        BATCH_CHK, USEM_SEQ, ORDER_NO, REVISION, RESULT_SEQ, PROC_CD, REP_ITEM_CD, DEPARTMENT,
        IDX_DT, IDX_SEQ
        )

        SELECT 'Z' AS GU, 
        D.SUB_NM AS BASE_ITEM_NM,
        A.ITEM_CD,
        C.ITEM_NM,
        A.LOT_NO,
        '' AS SL_NM,
        A.GOOD_QTY 
        - 
        ISNULL((SELECT SUM(USEM_QTY) FROM PD_USEM A1 WITH (NOLOCK) 
        WHERE A1.DIV_CD = A.DIV_CD AND A1.PLANT_CD = A.PLANT_CD AND A1.ITEM_CD = A.ITEM_CD AND A1.LOT_NO = A.LOT_NO 
          AND A1.BE_ORDER_NO = A.ORDER_NO AND A1.BE_REVISION = A.REVISION AND A1.BE_RESULT_SEQ = A.RESULT_SEQ AND A1.BE_PROC_CD = A.PROC_CD 
        ),0)
        - (ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_IN AA WITH (NOLOCK)                                    
        WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND AA.LOCATION_NO = A.LOCATION_NO                                    
        AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                  
        AND AA.MOVE_TYPE IN ('SR','506','503','311','601')                                  
        ),0) 
        -                                    
        ISNULL((SELECT SUM(AA.QTY) FROM ST_ITEM_OUT AA WITH (NOLOCK)                                    
        WHERE AA.DIV_CD = A.DIV_CD AND AA.PLANT_CD = A.PLANT_CD AND AA.ITEM_CD = A.ITEM_CD AND AA.LOT_NO = A.LOT_NO AND AA.WC_CD = A.WC_CD AND AA.PROC_CD = A.PROC_CD AND  AA.LOCATION_NO = A.LOCATION_NO                                  
        AND AA.ORDER_NO = A.ORDER_NO AND AA.ORDER_SEQ = A.REVISION AND AA.RESULTS_SEQ = A.RESULT_SEQ                                 
        AND AA.MOVE_TYPE IN ('SI' ,'506','503','311','601')                                  
        ),0)
        )
        AS QTY, -- 중요 부분 
        B.QTY AS STOCK_QTY,
        ISNULL(E.USEM_QTY,0) AS USEM_QTY,
        ISNULL(E.PLC_QTY,0) AS PLC_QTY,
        'N' AS BATCH_CHK, 
        0 AS USEM_SEQ, 
        E.BE_ORDER_NO AS ORDER_NO,
        E.BE_REVISION AS REVISION, 
        E.BE_RESULT_SEQ AS RESULT_SEQ,
        E.BE_PROC_CD AS PROC_CD,
        C.REP_ITEM_CD,
        A.DEPARTMENT,
        A.IDX_DT, A.IDX_SEQ
        FROM PD_ITEM_IN A WITH (NOLOCK)
        INNER JOIN @RESULT_PROC A1 ON A.WC_CD = A1.WC_CD AND A.LINE_CD = A1.LINE_CD AND A.PROC_CD = A1.PROC_CD 
        INNER JOIN ST_STOCK_NOW B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ITEM_CD = B.ITEM_CD 
        AND A.LOT_NO = B.LOT_NO AND A.WC_CD = B.WC_CD AND A.LINE_CD = B.LOCATION_NO AND A.PROC_CD = B.PROC_CD AND B.QTY > 0
        INNER JOIN V_ITEM C WITH (NOLOCK) ON A.PLANT_CD = C.PLANT_CD AND A.ITEM_CD = C.ITEM_CD 
        INNER JOIN BA_SUB_CD D WITH (NOLOCK) ON C.BASE_ITEM_CD = D.SUB_CD AND D.MAIN_CD = 'BA206'
        
        LEFT JOIN 
        (
          SELECT B.ITEM_CD, B.LOT_NO, SUM(B.USEM_QTY) AS USEM_QTY, SUM(B.PLC_QTY) AS PLC_QTY, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD 
          FROM PD_RESULT A WITH (NOLOCK) 
          INNER JOIN PD_USEM B WITH (NOLOCK) ON A.DIV_CD = B.DIV_CD AND A.PLANT_CD = B.PLANT_CD AND A.ORDER_NO = B.ORDER_NO AND A.REVISION = B.REVISION 
          AND A.ORDER_TYPE = B.ORDER_TYPE AND A.ORDER_FORM = B.ORDER_FORM AND A.ROUT_NO = B.ROUT_NO AND A.ROUT_VER = B.ROUT_VER AND A.WC_CD = B.WC_CD 
          AND A.LINE_CD = B.LINE_CD AND A.PROC_CD = B.PROC_CD AND A.RESULT_SEQ = B.RESULT_SEQ 
        WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.PROC_NO = @PROC_NO AND A.ORDER_NO = @ORDER_NO AND A.REVISION = @REVISION 
          AND A.ORDER_TYPE = @ORDER_TYPE AND A.ORDER_FORM = @ORDER_FORM AND A.ROUT_NO = @ROUT_NO AND A.ROUT_VER = @ROUT_VER 
          AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD AND A.PROC_CD = @PROC_CD AND A.S_CHK = 'N' AND A.RESULT_SEQ = @RESULT_SEQ 
          GROUP BY B.ITEM_CD, B.LOT_NO, B.BE_ORDER_NO, B.BE_REVISION, B.BE_RESULT_SEQ, B.BE_PROC_CD

        ) E ON A.ITEM_CD = E.ITEM_CD AND A.LOT_NO = E.LOT_NO AND A.ORDER_NO = E.BE_ORDER_NO AND A.REVISION = E.BE_REVISION AND A.RESULT_SEQ = E.BE_RESULT_SEQ
        AND A.PROC_CD = E.BE_PROC_CD    
        WHERE A.DIV_CD = @DIV_CD AND A.PLANT_CD = @PLANT_CD AND A.WC_CD = @WC_CD AND A.LINE_CD = @LINE_CD 
          AND A.ORDER_NO <> 'PD250113003'
      END       
  --  ) AA 
  --  WHERE (AA.QTY <> 0 AND AA.USEM_QTY >= 0) OR (AA.QTY = 0 AND AA.USEM_QTY > 0)
  --  ORDER BY AA.ITEM_CD DESC, AA.IDX_DT, AA.IDX_SEQ 


    SELECT DISTINCT
    AA.GU, 
    AA.BASE_ITEM_NM,
    AA.ITEM_CD, 
    AA.ITEM_NM, 
    AA.LOT_NO, 
    AA.SL_NM, 
    AA.QTY, 
    AA.STOCK_QTY, 
    AA.USEM_QTY, 
    AA.PLC_QTY,
    AA.BATCH_CHK,
    AA.USEM_SEQ, 
    AA.ORDEr_NO, 
    AA.REVISION, 
    AA.RESULT_SEQ, 
    AA.PROC_CD, 
    AA.REP_ITEM_CD, 
    AA.DEPARTMENT,
    AA.IDX_DT, AA.IDX_SEQ
    FROM @MAT_TABLE AA
    WHERE (AA.QTY <> 0 AND AA.USEM_QTY >= 0) OR (AA.QTY = 0 AND AA.USEM_QTY > 0)
   
    ORDER BY AA.ITEM_CD DESC, AA.IDX_DT, AA.IDX_SEQ 

  END 

END   




